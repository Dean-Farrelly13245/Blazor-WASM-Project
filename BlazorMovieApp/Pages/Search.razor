@page "/search"
@inject HttpClient Http

<h3>Search Movies</h3>

<div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input @bind="query" @bind:event="oninput" placeholder="Search..."
           style="padding:8px; width:280px; border-radius:6px; border:1px solid #ccc;" />

    <button @onclick="DoSearch"
            style="padding:8px 20px; border-radius:6px; border:none; background:#6c63ff; color:white;">
        Search
    </button>
</div>

@if (!string.IsNullOrEmpty(error))
{
    <p style="color:red">@error</p>
}
else if (loading)
{
    <p><em>Searching...</em></p>
}
else if (searched && results.Count == 0)
{
    <p>No results found.</p>
}
else if (results.Count > 0)
{
    <div style="color:#ccc; margin-bottom:12px;">Found @results.Count result(s)</div>

    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:15px;">
        @foreach (var item in results)
        {
            <div style="display:flex; gap:12px; padding:12px; border-radius:8px; background:#1f1f3a; cursor:pointer;"
                 @onclick="@(() => OnSearchMovieClicked(item))">
                <img src="@item.ImageUrl"
                     style="width:70px; height:105px; object-fit:cover; border-radius:6px;"
                     onerror="this.src='https://via.placeholder.com/70x105?text=No+Image'" />

                <div>
                    <div style="font-weight:bold; font-size:15px;">@item.Title</div>
                    <div style="color:#ccc; font-size:13px;">@item.Year</div>
                    <div style="color:#aaa; font-size:12px;">@item.Type</div>
                </div>
            </div>
        }
    </div>

    @if (showDetails)
    {
        <div style="
                   position:fixed;
                   inset:0;
                   background-color:rgba(0,0,0,0.6);
                   display:flex;
                   justify-content:center;
                   align-items:center;
                   z-index:1000;">
            <div style="
                       background:#1f1f3a;
                       padding:20px;
                       border-radius:10px;
                       max-width:600px;
                       width:90%;
                       color:white;
                       box-shadow:0 10px 25px rgba(0,0,0,0.5);">

                <button @onclick="CloseDetails"
                        style="float:right; background:transparent; border:none; color:white; font-size:18px; cursor:pointer;">
                    ✕
                </button>

                <h3 style="margin-top:0;">Movie Details</h3>

                @if (loadingDetails)
                {
                    <p><em>Loading details...</em></p>
                }
                else if (!string.IsNullOrEmpty(detailsError))
                {
                    <p style="color:red">@detailsError</p>
                }
                else if (selectedDetails == null)
                {
                    <p>No details available.</p>
                }
                else
                {
                    <div style="display:flex; gap:20px;">
                        @if (!string.IsNullOrEmpty(selectedDetails.ImageUrl))
                        {
                            <img src="@selectedDetails.ImageUrl"
                                 style="width:150px; border-radius:8px; object-fit:cover;" />
                        }

                        <div>
                            <h4 style="margin-top:0;">
                                @selectedDetails.Title
                                @if (selectedDetails.Year > 0)
                                {
                                    <text> (@selectedDetails.Year)</text>
                                }
                </h4>

                <p>
                    <strong>Runtime:</strong>
                    @(selectedDetails.RuntimeMinutes > 0
                                        ? selectedDetails.RuntimeMinutes + " minutes"
                                        : "Unknown")
                                                </p>

                <p>
                    <strong>Director:</strong>
                    @(string.IsNullOrEmpty(selectedDetails.Director)
                                        ? "Unknown"
                                        : selectedDetails.Director)
                </p>

                @if (selectedDetails.Writers != null && selectedDetails.Writers.Count > 0)
                            {
                                <p><strong>Writers:</strong> @string.Join(", ", selectedDetails.Writers)</p>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
}

@code {
    private string query = "";
    private bool loading;
    private bool searched;
    private string error = "";
    private List<SearchItem> results = new();
    private MovieDetails selectedDetails;
    private bool loadingDetails;
    private string detailsError;
    private bool showDetails;

    private async Task DoSearch()
    {
        error = "";
        results.Clear();
        searched = false;
        showDetails = false;
        selectedDetails = null;

        if (string.IsNullOrWhiteSpace(query))
        {
            error = "Enter a search.";
            return;
        }

        if (query.Length < 3)
        {
            error = "Enter 3 characters.";
            return;
        }

        loading = true;

        try
        {
            var url = $"https://imdb232.p.rapidapi.com/api/search?q={Uri.EscapeDataString(query)}&count=40";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            request.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var api = System.Text.Json.JsonSerializer.Deserialize<SearchResponse>(
                json,
                new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

            if (api != null &&
                api.data != null &&
                api.data.mainSearch != null &&
                api.data.mainSearch.edges != null)
            {
                results = api.data.mainSearch.edges
                    .Select(edge => edge.node.entity)
                    .Where(entity => entity != null && entity.titleText != null)
                    .Select(entity => new SearchItem
                    {
                        Id = entity.id,
                        Title = entity.titleText.text,
                        Year = entity.releaseYear?.year?.ToString(),
                        Type = entity.titleType?.id,
                        ImageUrl = entity.primaryImage?.url
                    })
                    .ToList();
            }

            searched = true;
        }
        catch
        {
            error = "Something went wrong.";
        }

        loading = false;
    }

    private async Task OnSearchMovieClicked(SearchItem item)
    {
        showDetails = true;
        await LoadMovieDetailsAsync(item);
    }

    private void CloseDetails()
    {
        showDetails = false;
    }

    private async Task LoadMovieDetailsAsync(SearchItem movie)
    {
        if (movie == null || string.IsNullOrEmpty(movie.Id))
        {
            detailsError = "No id for this movie.";
            selectedDetails = null;
            return;
        }

        loadingDetails = true;
        detailsError = "";
        selectedDetails = null;

        try
        {
            var request = new HttpRequestMessage();
            request.Method = HttpMethod.Get;
            request.RequestUri = new Uri("https://imdb232.p.rapidapi.com/api/title/get-extended-details?tt=" + movie.Id);
            request.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            request.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();
            var json = await response.Content.ReadAsStringAsync();

            var options = new System.Text.Json.JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };

            var result = System.Text.Json.JsonSerializer.Deserialize<ExtendedDetailsResponse>(json, options);

            if (result == null || result.data == null || result.data.title == null)
            {
                detailsError = "No details found.";
                selectedDetails = null;
            }
            else
            {
                var t = result.data.title;
                var d = new MovieDetails();

                d.Title = t.titleText != null ? t.titleText.text : "";

                if (t.releaseYear != null && t.releaseYear.year.HasValue)
                {
                    d.Year = t.releaseYear.year.Value;
                }

                if (t.primaryImage != null)
                {
                    d.ImageUrl = t.primaryImage.url;
                }

                if (t.runtime != null)
                {
                    d.RuntimeMinutes = t.runtime.seconds / 60;
                }

                d.Director = "";
                d.Writers = new List<string>();

                if (t.credits != null && t.credits.edges != null)
                {
                    foreach (var edge in t.credits.edges)
                    {
                        if (edge.node == null ||
                            edge.node.category == null ||
                            edge.node.name == null ||
                            edge.node.name.nameText == null)
                        {
                            continue;
                        }

                        string catId = edge.node.category.id;
                        string personName = edge.node.name.nameText.text;

                        if (catId == "director" && string.IsNullOrEmpty(d.Director))
                        {
                            d.Director = personName;
                        }
                        else if (catId == "writer")
                        {
                            if (!d.Writers.Contains(personName))
                            {
                                d.Writers.Add(personName);
                            }
                        }
                    }
                }

                selectedDetails = d;
            }
        }
        catch (Exception ex)
        {
            detailsError = ex.Message;
            selectedDetails = null;
        }
        finally
        {
            loadingDetails = false;
        }
    }
    public class SearchResponse
    {
        public SearchData data { get; set; }
    }
    public class SearchData
    {
        public MainSearch mainSearch { get; set; }
    }
    public class MainSearch
    {
        public List<SearchEdge> edges { get; set; }
    }
    public class SearchEdge
    {
        public SearchNode node { get; set; }
    }
    public class SearchNode
    {
        public SearchEntity entity { get; set; }
    }
    public class SearchEntity
    {
        public string id { get; set; }
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public TitleType titleType { get; set; }
        public PrimaryImage primaryImage { get; set; }
    }
    public class TitleText
    {
        public string text { get; set; }
    }

    public class ReleaseYear
    {
        public int? year { get; set; }
    }

    public class TitleType
    {
        public string id { get; set; }
    }

    public class PrimaryImage
    {
        public string url { get; set; }
    }
    public class SearchItem
    {
        public string Id { get; set; }
        public string Title { get; set; }
        public string Year { get; set; }
        public string Type { get; set; }
        public string ImageUrl { get; set; }
    }
    public class ExtendedDetailsResponse
    {
        public ExtendedDetailsData data { get; set; }
    }

    public class ExtendedDetailsData
    {
        public ExtendedTitle title { get; set; }
    }

    public class ExtendedTitle
    {
        public string id { get; set; }
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public PrimaryImage primaryImage { get; set; }
        public Runtime runtime { get; set; }
        public Credits credits { get; set; }
    }

    public class Runtime
    {
        public int seconds { get; set; }
    }

    public class Credits
    {
        public List<CreditEdge> edges { get; set; }
    }

    public class CreditEdge
    {
        public CreditNode node { get; set; }
    }

    public class CreditNode
    {
        public CreditCategory category { get; set; }
        public CreditName name { get; set; }
    }

    public class CreditCategory
    {
        public string id { get; set; }
        public string text { get; set; }
    }

    public class CreditName
    {
        public NameText nameText { get; set; }
    }

    public class NameText
    {
        public string text { get; set; }
    }

    public class MovieDetails
    {
        public string Title { get; set; }
        public int Year { get; set; }
        public string ImageUrl { get; set; }
        public int RuntimeMinutes { get; set; }
        public string Director { get; set; }
        public List<string> Writers { get; set; }
    }
}
