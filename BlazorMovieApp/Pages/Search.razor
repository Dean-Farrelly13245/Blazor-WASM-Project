@page "/search"
@inject HttpClient Http

<h2>Search</h2>

<input @bind="query"
       @oninput="OnSearchChanged"
       placeholder="Search for movies or shows..."
       style="padding:8px; width:300px; border-radius:6px; border:1px solid #444;" />

@if (loading)
{
    <p>Searching...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <p style="color:red">@error</p>
}
else if (results.Count == 0 && query.Length > 1)
{
    <p>No results found.</p>
}
else
{
    <div style="margin-top:20px; display:grid; gap:15px; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));">
        @foreach (var item in results)
        {
            <div style="display:flex; gap:10px; background:#1f1f3a; padding:10px; border-radius:8px;">
                <img src="@item.ImageUrl"
                     style="width:70px; height:105px; object-fit:cover; border-radius:6px;" />

                <div>
                    <div style="font-weight:bold;">@item.Title</div>
                    <div style="font-size:12px; color:#ccc;">@item.Year • @item.Type</div>
                </div>
            </div>
        }
    </div>
}

@code {
    string query = "";
    bool loading = false;
    string error = "";
    List<SearchItem> results = new();

    async Task OnSearchChanged(ChangeEventArgs e)
    {
        query = e.Value?.ToString() ?? "";

        if (query.Length < 2)
        {
            results.Clear();
            return;
        }

        await RunSearch();
    }

    async Task RunSearch()
    {
        try
        {
            loading = true;
            error = "";
            results.Clear();

            var req = new HttpRequestMessage
            {
                Method = HttpMethod.Get,
                RequestUri = new Uri($"https://imdb232.p.rapidapi.com/api/search?query={query}")
            };

            req.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            req.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var res = await Http.SendAsync(req);
            res.EnsureSuccessStatusCode();

            var json = await res.Content.ReadAsStringAsync();

            var data = System.Text.Json.JsonSerializer.Deserialize<ApiResponse>(json,
                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            results = data?.data?.searchResults?
                .Where(x => x.titleText?.text != null)
                .Select(x => new SearchItem
                {
                    Title = x.titleText.text,
                    Year = x.releaseYear?.year?.ToString() ?? "N/A",
                    Type = x.titleType?.id ?? "unknown",
                    ImageUrl = x.primaryImage?.url ?? "https://via.placeholder.com/70x105?text=No+Image"
                })
                .ToList()
                ?? new List<SearchItem>();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }

        loading = false;
    }

    public class ApiResponse
    {
        public ApiData data { get; set; }
    }

    public class ApiData
    {
        public List<SearchNode> searchResults { get; set; }
    }

    public class SearchNode
    {
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public PrimaryImage primaryImage { get; set; }
        public TitleType titleType { get; set; }
    }

    public class TitleText { public string text { get; set; } }
    public class ReleaseYear { public int? year { get; set; } }
    public class PrimaryImage { public string url { get; set; } }
    public class TitleType { public string id { get; set; } }

    public class SearchItem
    {
        public string Title { get; set; }
        public string Year { get; set; }
        public string Type { get; set; }
        public string ImageUrl { get; set; }
    }
}
