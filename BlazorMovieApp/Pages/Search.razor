@page "/search"
@inject HttpClient Http

<h3>Search Movies</h3>

<div style="margin-bottom:15px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input @bind="query" @bind:event="oninput" placeholder="Search..."
           style="padding:8px; width:280px; border-radius:6px; border:1px solid #ccc;" />

    <button @onclick="DoSearch"
            style="padding:8px 20px; border-radius:6px; border:none; background:#6c63ff; color:white;">
        Search
    </button>
</div>

@if (!string.IsNullOrEmpty(error))
{
    <p style="color:red">@error</p>
}
else if (loading)
{
    <p><em>Searching...</em></p>
}
else if (searched && results.Count == 0)
{
    <p>No results found.</p>
}
else if (results.Count > 0)
{
    <div style="color:#ccc; margin-bottom:12px;">Found @results.Count result(s)</div>

    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:15px;">
        @foreach (var item in results)
        {
            <div style="display:flex; gap:12px; padding:12px; border-radius:8px; background:#1f1f3a;">
                <img src="@item.ImageUrl"
                     style="width:70px; height:105px; object-fit:cover; border-radius:6px;"
                     onerror="this.src='https://via.placeholder.com/70x105?text=No+Image'" />

                <div>
                    <div style="font-weight:bold; font-size:15px;">@item.Title</div>
                    <div style="color:#ccc; font-size:13px;">@item.Year</div>
                    <div style="color:#aaa; font-size:12px;">@item.Type</div>
                </div>
            </div>
        }
    </div>
}

@code {
    private string query = "";
    private bool loading;
    private bool searched;
    private string error = "";
    private List<SearchItem> results = new();

    private async Task DoSearch()
    {
        error = "";
        results.Clear();
        searched = false;

        if (string.IsNullOrWhiteSpace(query))
        {
            error = "Enter a search.";
            return;
        }

        if (query.Length < 3)
        {
            error = "Enter at least 3 characters.";
            return;
        }

        loading = true;

        try
        {
            var url = $"https://imdb232.p.rapidapi.com/api/search?q={Uri.EscapeDataString(query)}&count=40";

            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            request.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var api = System.Text.Json.JsonSerializer.Deserialize<SearchResponse>(
                json,
                new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

            if (api != null &&
                api.data != null &&
                api.data.mainSearch != null &&
                api.data.mainSearch.edges != null)
            {
                results = api.data.mainSearch.edges
                    .Select(edge => edge.node.entity)
                    .Where(entity => entity != null && entity.titleText != null)
                    .Select(entity => new SearchItem
                    {
                        Title = entity.titleText.text,
                        Year = entity.releaseYear?.year?.ToString(),
                        Type = entity.titleType?.id,
                        ImageUrl = entity.primaryImage?.url
                    })
                    .ToList();
            }

            searched = true;
        }
        catch
        {
            error = "Something went wrong.";
        }

        loading = false;
    }

    public class SearchResponse
    {
        public SearchData data { get; set; }
    }

    public class SearchData
    {
        public MainSearch mainSearch { get; set; }
    }

    public class MainSearch
    {
        public List<SearchEdge> edges { get; set; }
    }

    public class SearchEdge
    {
        public SearchNode node { get; set; }
    }

    public class SearchNode
    {
        public SearchEntity entity { get; set; }
    }

    public class SearchEntity
    {
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public TitleType titleType { get; set; }
        public PrimaryImage primaryImage { get; set; }
    }

    public class TitleText
    {
        public string text { get; set; }
    }

    public class ReleaseYear
    {
        public int? year { get; set; }
    }

    public class TitleType
    {
        public string id { get; set; }
    }

    public class PrimaryImage
    {
        public string url { get; set; }
    }

    public class SearchItem
    {
        public string Title { get; set; }
        public string Year { get; set; }
        public string Type { get; set; }
        public string ImageUrl { get; set; }
    }
}
