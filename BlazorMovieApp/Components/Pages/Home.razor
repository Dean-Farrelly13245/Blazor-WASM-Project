@page "/"
@using System.Linq
@inject HttpClient Http
@rendermode InteractiveServer

@if (!loaded && string.IsNullOrEmpty(errormessage))
{
    <p><em>Loading...</em></p>
}
else if (!string.IsNullOrEmpty(errormessage))
{
    <p style="color:red">@errormessage</p>
}
else
{
    <h3>Popular Movies</h3>

    <div style="display:flex; overflow-x:auto; gap:20px; padding-bottom:10px;">
        @foreach (var m in movieList)
        {
            <div style="flex:0 0 auto; width:150px; text-align:center;">
                <img src="@m.ImageUrl" width="150" style="border-radius:6px;" />
                <div><strong>@m.Title</strong></div>
                <div>@m.Year</div>
                <div>Rank: @m.Rank</div>
            </div>
        }
    </div>

    <h3 style="margin-top:30px;">Popular TV Shows</h3>

    <div style="display:flex; overflow-x:auto; gap:20px; padding-bottom:10px;">
        @foreach (var m in tvList)
        {
            <div style="flex:0 0 auto; width:150px; text-align:center;">
                <img src="@m.ImageUrl" width="150" style="border-radius:6px;" />
                <div><strong>@m.Title</strong></div>
                <div>@m.Year</div>
                <div>Rank: @m.Rank</div>
            </div>
        }
    </div>

    <h3 style="margin-top:40px;">Browse Titles</h3>

    <div style="display:flex; gap:20px; margin-bottom:15px; align-items:flex-end;">
        <div>
            <label>Type</label><br />
            <select value="@selectedType" @onchange="@((ChangeEventArgs e) => { selectedType = e.Value?.ToString() ?? "all"; OnFilterChanged(); })">
                <option value="all">All</option>
                <option value="movie">Movies</option>
                <option value="tv">TV Shows</option>
            </select>
        </div>

        <div>
            <label>Sort</label><br />
            <select value="@selectedSort" @onchange="@((ChangeEventArgs e) => { selectedSort = e.Value?.ToString() ?? "newest"; OnFilterChanged(); })">
                <option value="newest">Newest</option>
                <option value="rank">Highest Rank</option>
            </select>
        </div>

        <div>
            <label>Genre</label><br />
            <select value="@selectedGenre" @onchange="@((ChangeEventArgs e) => { selectedGenre = e.Value?.ToString() ?? "all"; OnFilterChanged(); })">
                <option value="all">All</option>
                <option value="Action">Action</option>
                <option value="Drama">Drama</option>
                <option value="Comedy">Comedy</option>
                <option value="Crime">Crime</option>
                <option value="Horror">Horror</option>
            </select>
        </div>

        <div>
            <button @onclick="Search" style="padding:6px 14px; border-radius:6px; border:none; background:#6c63ff; color:white;">
                Apply filters
            </button>
        </div>
    </div>

    <div style="font-size:12px; margin-bottom:10px;">
        Current: @selectedType, @selectedSort, @selectedGenre (Total: @filteredTitles.Count items)
    </div>

    @if (filteredTitles.Count == 0)
    {
        <p>No titles match these filters.</p>
    }
    else
    {
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:15px;">
            @foreach (var item in filteredTitles)
            {
                <div style="display:flex; gap:10px; padding:10px; border-radius:8px; background:#1f1f3a;">
                    <img src="@item.ImageUrl" style="width:70px; height:105px; object-fit:cover; border-radius:8px;" />
                    <div>
                        <div style="font-weight:bold;">@item.Title</div>
                        <div style="font-size:12px; color:#ccc;">@item.Year • Rank @item.Rank • @item.Genre • @item.Type</div>
                    </div>
                </div>
            }
        </div>
    }
}

@code {
    private List<MovieItem> allTitles = new();
    private List<MovieItem> filteredTitles = new();
    private List<MovieItem> movieList = new();
    private List<MovieItem> tvList = new();

    private string selectedType = "all";
    private string selectedSort = "newest";
    private string selectedGenre = "all";

    private bool loaded;
    private string errormessage;

    protected override async Task OnInitializedAsync()
    {
        await GetTitlesAsync();
    }

    private async Task GetTitlesAsync()
    {
        try
        {
            var request = new HttpRequestMessage
            {
                Method = HttpMethod.Get,
                RequestUri = new Uri("https://imdb232.p.rapidapi.com/api/title/get-most-popular?limit=30&topMeterTitlesType=ALL")
            };

            request.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            request.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var result = System.Text.Json.JsonSerializer.Deserialize<ApiResponse>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (result?.data?.topMeterTitles?.edges == null)
            {
                errormessage = "No data received from API.";
                loaded = false;
                return;
            }

            allTitles = result.data.topMeterTitles.edges.Select(e =>
            {
                var r = e.node.meterRanking.currentRank;
                string g;
                if (r % 5 == 0) g = "Horror";
                else if (r % 4 == 0) g = "Crime";
                else if (r % 3 == 0) g = "Comedy";
                else if (r % 2 == 0) g = "Drama";
                else g = "Action";

                return new MovieItem
                {
                    Title = e.node.titleText.text,
                    Year = e.node.releaseYear.year.ToString(),
                    ImageUrl = e.node.primaryImage?.url,
                    Rank = r,
                    Type = e.node.titleType?.id,
                    Genre = g
                };
            }).ToList();

            movieList = allTitles
                .Where(x => x.Type == "movie")
                .OrderBy(x => x.Rank)
                .Take(10)
                .ToList();

            tvList = allTitles
                .Where(x => x.Type != "movie")
                .OrderBy(x => x.Rank)
                .Take(10)
                .ToList();

            loaded = true;
            errormessage = string.Empty;

            ApplyFilters();
        }
        catch (Exception ex)
        {
            loaded = false;
            errormessage = ex.Message;
        }
    }

    private async Task Search()
    {
        if (!loaded)
        {
            await GetTitlesAsync();
        }
        else
        {
            ApplyFilters();
        }

        StateHasChanged();
    }

    private void OnFilterChanged()
    {
        if (loaded)
        {
            ApplyFilters();
            InvokeAsync(StateHasChanged);
        }
    }

    private void ApplyFilters()
    {
        if (allTitles == null || allTitles.Count == 0)
        {
            filteredTitles = new List<MovieItem>();
            return;
        }

        IEnumerable<MovieItem> q = allTitles;

        if (selectedType == "movie")
            q = q.Where(x => x.Type == "movie");
        else if (selectedType == "tv")
            q = q.Where(x => x.Type != "movie");

        if (selectedGenre != "all")
            q = q.Where(x => x.Genre == selectedGenre);

        if (selectedSort == "rank")
            q = q.OrderBy(x => x.Rank);
        else
            q = q.OrderByDescending(x => int.Parse(x.Year));

        filteredTitles = q.ToList();
    }

    public class ApiResponse
    {
        public ApiData data { get; set; }
    }

    public class ApiData
    {
        public TopTitles topMeterTitles { get; set; }
    }

    public class TopTitles
    {
        public List<Edge> edges { get; set; }
    }

    public class Edge
    {
        public MovieNode node { get; set; }
    }

    public class MovieNode
    {
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public PrimaryImage primaryImage { get; set; }
        public MeterRanking meterRanking { get; set; }
        public TitleType titleType { get; set; }
    }

    public class TitleText { public string text { get; set; } }
    public class ReleaseYear { public int year { get; set; } }
    public class PrimaryImage { public string url { get; set; } }
    public class MeterRanking { public int currentRank { get; set; } }
    public class TitleType { public string id { get; set; } }

    public class MovieItem
    {
        public string Title { get; set; }
        public string Year { get; set; }
        public string ImageUrl { get; set; }
        public int Rank { get; set; }
        public string Type { get; set; }
        public string Genre { get; set; }
    }
}
