@page "/"
@using System.Linq
@inject HttpClient Http

@if (movies == null && errorMessage == null)
{
    <p><em>Loading movies...</em></p>
}
else if (errorMessage != null)
{
    <p style="color:red; white-space:pre-wrap">@errorMessage</p>
}
else
{
    <h3>Popular Movies</h3>

    <div style="display:flex; flex-wrap:nowrap; overflow-x:auto; gap:20px; padding-bottom:10px;">
        @if (movieList != null)
        {
            foreach (var m in movieList)
            {
                <div style="flex:0 0 auto; width:150px; text-align:center;">
                    <img src="@m.ImageUrl" width="150" style="border-radius:6px;" />
                    <div><strong>@m.Title</strong></div>
                    <div>@m.Year</div>
                    <div>Rank: @m.Rank</div>
                </div>
            }
        }
    </div>

    <h3 style="margin-top:40px;">Popular TV Shows</h3>

    <div style="display:flex; flex-wrap:nowrap; overflow-x:auto; gap:20px; padding-bottom:10px;">
        @if (tvList != null)
        {
            foreach (var m in tvList)
            {
                <div style="flex:0 0 auto; width:150px; text-align:center;">
                    <img src="@m.ImageUrl" width="150" style="border-radius:6px;" />
                    <div><strong>@m.Title</strong></div>
                    <div>@m.Year</div>
                    <div>Rank: @m.Rank</div>
                </div>
            }
        }
    </div>

    <h3 class="section-title" style="margin-top:24px;">Browse & sort titles</h3>

    <div class="browse-section">
        <div class="browse-controls">

            <!-- Filter 1: Type -->
            <div>
                <label>Type</label>
                <select @onchange="OnTypeChanged">
                    <option value="all">All</option>
                    <option value="movie">Movies</option>
                    <option value="tv">TV Shows</option>
                </select>
            </div>

            <!-- Filter 2: Sort By -->
            <div>
                <label>Sort by</label>
                <select @onchange="OnSortChanged">
                    <option value="newest">Newest</option>
                    <option value="rank">Highest Rank</option>
                    <option value="trending">Trending</option>
                </select>
            </div>

            <!-- Filter 3: Genre -->
            <div>
                <label>Genre</label>
                <select @onchange="OnGenreChanged">
                    <option value="all">All</option>
                    <option value="Action">Action</option>
                    <option value="Drama">Drama</option>
                    <option value="Comedy">Comedy</option>
                    <option value="Crime">Crime</option>
                    <option value="Horror">Horror</option>
                </select>
            </div>
        </div>

        <div class="browse-grid">
            @if (browseList != null && browseList.Count > 0)
            {
                foreach (var item in browseList)
                {
                    <div class="browse-card">
                        <img src="@item.ImageUrl" style="width:70px; border-radius:8px;" />
                        <div class="info">
                            <div class="name">@item.Title</div>
                            <div class="meta">
                                @item.Year • Rank @item.Rank • @item.Type • @item.Genre
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p>No items to show with this filter.</p>
            }
        </div>
    </div>
}

@code {
    private List<MovieItem>? movies;
    private List<MovieItem>? movieList;
    private List<MovieItem>? tvList;
    private string? errorMessage;

    // browse/sort stuff
    private string selectedType = "all";
    private string selectedSort = "newest";
    private string selectedGenre = "all";
    private List<MovieItem> browseList = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMoviesAsync();

        if (movies != null)
        {
            movieList = movies
                .Where(x => x.Type == "movie")
                .OrderBy(x => x.Rank)
                .Take(10)
                .ToList();

            tvList = movies
                .Where(x => x.Type != null && x.Type != "movie")
                .OrderBy(x => x.Rank)
                .Take(10)
                .ToList();

            UpdateBrowseList();
        }
    }

    private async Task LoadMoviesAsync()
    {
        try
        {
            var request = new HttpRequestMessage
            {
                Method = HttpMethod.Get,
                RequestUri = new Uri("https://imdb232.p.rapidapi.com/api/title/get-most-popular?limit=30&topMeterTitlesType=ALL")
            };

            request.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            request.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var result = System.Text.Json.JsonSerializer.Deserialize<ApiResponse>(json);

            movies = result?.data?.topMeterTitles?.edges?
                .Select(e =>
                {
                    var rank = e.node.meterRanking.currentRank;

                    // simple fake genre based on rank, just so the filter does something
                    string genre;
                    if (rank % 5 == 0) genre = "Horror";
                    else if (rank % 4 == 0) genre = "Crime";
                    else if (rank % 3 == 0) genre = "Comedy";
                    else if (rank % 2 == 0) genre = "Drama";
                    else genre = "Action";

                    return new MovieItem
                    {
                        Title = e.node.titleText.text,
                        Year = e.node.releaseYear.year.ToString(),
                        ImageUrl = e.node.primaryImage?.url,
                        Rank = rank,
                        Type = e.node.titleType?.id,
                        Genre = genre
                    };
                })
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private void OnTypeChanged(ChangeEventArgs e)
    {
        selectedType = e.Value?.ToString() ?? "all";
        UpdateBrowseList();
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        selectedSort = e.Value?.ToString() ?? "newest";
        UpdateBrowseList();
    }

    private void OnGenreChanged(ChangeEventArgs e)
    {
        selectedGenre = e.Value?.ToString() ?? "all";
        UpdateBrowseList();
    }

    private void UpdateBrowseList()
    {
        if (movies == null)
        {
            browseList = new();
            return;
        }

        IEnumerable<MovieItem> query = movies;

        // Filter 1: type (movies / tv / all)
        if (selectedType == "movie")
        {
            query = query.Where(x => x.Type == "movie");
        }
        else if (selectedType == "tv")
        {
            query = query.Where(x => x.Type != null && x.Type != "movie");
        }

        // Filter 2: genre
        if (selectedGenre != "all")
        {
            query = query.Where(x => x.Genre == selectedGenre);
        }

        // Filter 3: sort
        switch (selectedSort)
        {
            case "rank":
                query = query.OrderBy(x => x.Rank);
                break;

            case "trending":
                // simple "trending" = random order
                query = query.OrderBy(x => Guid.NewGuid());
                break;

            case "newest":
            default:
                query = query.OrderByDescending(x => x.Year);
                break;
        }

        browseList = query.Take(20).ToList();
    }

    public class ApiResponse
    {
        public ApiData data { get; set; }
    }

    public class ApiData
    {
        public TopTitles topMeterTitles { get; set; }
    }

    public class TopTitles
    {
        public List<Edge> edges { get; set; }
    }

    public class Edge
    {
        public MovieNode node { get; set; }
    }

    public class MovieNode
    {
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public PrimaryImage primaryImage { get; set; }
        public MeterRanking meterRanking { get; set; }
        public TitleType titleType { get; set; }
    }

    public class TitleType
    {
        public string id { get; set; } // movie / tvSeries / etc.
    }

    public class TitleText
    {
        public string text { get; set; }
    }

    public class ReleaseYear
    {
        public int year { get; set; }
    }

    public class PrimaryImage
    {
        public string url { get; set; }
    }

    public class MeterRanking
    {
        public int currentRank { get; set; }
    }

    public class MovieItem
    {
        public string Title { get; set; }
        public string Year { get; set; }
        public string ImageUrl { get; set; }
        public int Rank { get; set; }
        public string Type { get; set; }
        public string Genre { get; set; }
    }
}
