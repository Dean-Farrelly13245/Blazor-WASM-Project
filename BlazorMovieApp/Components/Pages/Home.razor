@page "/"
@inject HttpClient Http

@if (movies == null && errorMessage == null)
{
    <p><em>Loading movies...</em></p>
}
else if (errorMessage != null)
{
    <p style="color:red; white-space:pre-wrap">@errorMessage</p>
}
else
{
    <h3>Popular Movies</h3>

    <div style="display:flex; flex-wrap:nowrap; overflow-x:auto; gap:20px; padding-bottom:10px;">
        @if (movieList != null)
        {
            foreach (var m in movieList)
            {
                <div style="flex:0 0 auto; width:150px; text-align:center;">
                    <img src="@m.ImageUrl" width="150" style="border-radius:6px;" />
                    <div><strong>@m.Title</strong></div>
                    <div>@m.Year</div>
                    <div>Rank: @m.Rank</div>
                </div>
            }
        }
    </div>

    <h3 style="margin-top:40px;">Popular TV Shows</h3>

    <div style="display:flex; flex-wrap:nowrap; overflow-x:auto; gap:20px; padding-bottom:10px;">
        @if (tvList != null)
        {
            foreach (var m in tvList)
            {
                <div style="flex:0 0 auto; width:150px; text-align:center;">
                    <img src="@m.ImageUrl" width="150" style="border-radius:6px;" />
                    <div><strong>@m.Title</strong></div>
                    <div>@m.Year</div>
                    <div>Rank: @m.Rank</div>
                </div>
            }
        }
    </div>



}

@code {
    private List<MovieItem>? movies;
    private List<MovieItem>? movieList;
    private List<MovieItem>? tvList;
    private string? errorMessage;


    protected override async Task OnInitializedAsync()
    {
        await LoadMoviesAsync();

        if (movies != null)
        {
            movieList = movies
                .Where(x => x.Type == "movie")
                .OrderBy(x => x.Rank)
                .Take(10)
                .ToList();

            tvList = movies
                .Where(x => x.Type != "movie")
                .OrderBy(x => x.Rank)
                .Take(10)
                .ToList();
        }

    }

    private async Task LoadMoviesAsync()
    {
        try
        {
            var request = new HttpRequestMessage
            {
                Method = HttpMethod.Get,
                RequestUri = new Uri("https://imdb232.p.rapidapi.com/api/title/get-most-popular?limit=30&topMeterTitlesType=ALL")
            };

            request.Headers.Add("x-rapidapi-key", "efd389adbamsh2bf57e66af80e83p1faf69jsndbb9a365e1d3");
            request.Headers.Add("x-rapidapi-host", "imdb232.p.rapidapi.com");

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var json = await response.Content.ReadAsStringAsync();
            var result = System.Text.Json.JsonSerializer.Deserialize<ApiResponse>(json);

            movies = result?.data?.topMeterTitles?.edges?
                .Select(e => new MovieItem
                {
                    Title = e.node.titleText.text,
                    Year = e.node.releaseYear.year.ToString(),
                    ImageUrl = e.node.primaryImage?.url,
                    Rank = e.node.meterRanking.currentRank,
                    Type = e.node.titleType?.id


                })
                .ToList();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    public class ApiResponse
    {
        public ApiData data { get; set; }
    }

    public class ApiData
    {
        public TopTitles topMeterTitles { get; set; }
    }

    public class TopTitles
    {
        public List<Edge> edges { get; set; }
    }

    public class Edge
    {
        public MovieNode node { get; set; }
    }

    public class MovieNode
    {
        public TitleText titleText { get; set; }
        public ReleaseYear releaseYear { get; set; }
        public PrimaryImage primaryImage { get; set; }
        public MeterRanking meterRanking { get; set; }
        public TitleType titleType { get; set; }
    }

    public class TitleType
    {
        public string id { get; set; }             // movie / tvSeries
    }

    public class TitleText
    {
        public string text { get; set; }
    }

    public class ReleaseYear
    {
        public int year { get; set; }
    }

    public class PrimaryImage
    {
        public string url { get; set; }
    }

    public class MeterRanking
    {
        public int currentRank { get; set; }
    }

    public class MovieItem
    {
        public string Title { get; set; }
        public string Year { get; set; }
        public string ImageUrl { get; set; }
        public int Rank { get; set; }
        public string Type { get; set; }
    }
}
